<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Perspective Transform with OpenCV.js</title>
<script src="https://cdn.jsdelivr.net/npm/opencv4/dist/opencv.js"></script>
</head>
<body>
<input type="file" id="fileInput">
<canvas id="canvas" width="600" height="400"></canvas>
<canvas id="transformedCanvas" width="600" height="400"></canvas>
<script>
// 设置文件上传监听器
const fileInput = document.getElementById('fileInput');
fileInput.addEventListener('change', handleFileUpload);

// 处理文件上传
function handleFileUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(event) {
    const img = new Image();
    img.onload = function() {
      // 渲染图像
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);

      // 等待 OpenCV.js 初始化完成
      cv.onRuntimeInitialized = () => {
        console.log('OpenCV.js initialized');
        // 计算透视变换矩阵
        const srcPoints = new cv.Mat([
          [0, 0],
          [img.width, 0],
          [img.width, img.height],
          [0, img.height]
        ], cv.CV_32FC2);
        const dstPoints = new cv.Mat([
          [0, 0],
          [img.width, 0],
          [img.width, img.height],
          [0, img.height]
        ], cv.CV_32FC2);
        const perspectiveMatrix = cv.getPerspectiveTransform(srcPoints, dstPoints);

        // 应用透视变换
        const transformedCanvas = document.getElementById('transformedCanvas');
        const transformedCtx = transformedCanvas.getContext('2d');
        const transformedImg = new cv.Mat();
        cv.warpPerspective(cv.imread(canvas), transformedImg, perspectiveMatrix, img.size());
        cv.imshow(transformedCanvas, transformedImg);
        transformedImg.delete();
        srcPoints.delete();
        dstPoints.delete();
      };
    };
    img.src = event.target.result;
  };
  reader.readAsDataURL(file);
}
</script>
</body>
</html>
