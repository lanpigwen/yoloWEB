<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Frame Capture</title>
</head>
<body>
    <video id="video" autoplay></video>
    <canvas id="canvas" width="640" height="640" ></canvas>
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let imageCapture;

        // 获取视频流
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    imageCapture = new ImageCapture(stream.getVideoTracks()[0]);
                    captureFrame();
                };
            })
            .catch(error => console.error('Error accessing media devices:', error));


            
            function sendData(imageData,imageWidth,imageHeight,flipFrame) {
                if(jump){
                    jpcount++;
                }
                else{
                    jpcount=1;
                }
                fetch("/process_frame", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ 
                    image_data: imageData.toDataURL("image/jpeg"),
                    jumpORnot:jpcount%2,
                    imgWidth:imageWidth,
                    imgHeight:imageHeight,
                    imgFlip:flipFrame,
                    uuid:uniqueIdentifier
                }),
                })
                .then((response) => response.json())
                .then((data) => {
                    if(resultCanvas.width==0 || resultCanvas.height==0){
                        resultCanvas.width=video.videoWidth;
                        resultCanvas.height=video.videoHeight;
                    }
                    if(video.style.zIndex<imgElement.style.zIndex || video.style.zIndex<resultCanvas.style.zIndex){

                        let ct0=Date.now();
                        imgElement.src = "data:image/jpeg;base64," + data.image_data;
                        console.log(Date.now()-ct0);
                    }

                    })
                .catch((error) => {
                    console.error("Error sending data to server: ", error);
                    // alert("An error occurred while processing the frame. Please try again later.");
                });
            }

        function captureFrame() {
            // 从视频流中捕获一帧图像
            imageCapture.grabFrame()
                .then(imageBitmap => {
                    // 在 canvas 上绘制图像
                    let ct0=Date.now();
                    ctx.drawImage(imageBitmap, 0, 0, canvas.width, canvas.height);
                    let ct1=Date.now();
                    // 将图像数据提取为数据 URL
                    const imageDataUrl = canvas.toDataURL('image/jpeg');
                    console.log("draw",ct1-ct0,"toUrl",Date.now()-ct1);
                    // 现在你可以处理 imageDataUrl，例如将其发送到服务器或在页面上显示
                    // console.log('Captured frame:', imageDataUrl);

                    // 继续捕获下一帧
                    requestAnimationFrame(captureFrame);
                })
                .catch(error => console.error('Error capturing frame:', error));
        }
    </script>
</body>
</html>
