<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据可视化展示</title>
    <link rel="icon" href="static/5logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        .profile-header {
            background: url('../static/2index.jpg'); /* 背景图片 */
            background-size: cover;
            /* padding: 20px; */
            padding-top: 0px ;
            text-align: center;
            color: white;
            margin-bottom: 15px;
        }
        .chart-container {
            margin-top: 10px;
        }
        .chart {
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
    </style>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        .axis path,
        .axis line {
            fill: none;
            stroke: black;
            shape-rendering: crispEdges;
        }

        .line {
            fill: none;
            stroke-width: 10px;
        }

        .make {
            stroke: #f55602;
        }

        .miss {
            stroke: #5b74a6;
        }
    </style>
    <style>
        #legend {
            display: flex;
            /* justify-content: center; */
            flex-wrap: wrap; /* 确保图例项可以根据需要换行 */
            margin-top: 0px;
            margin-left: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 20px; /* 间隔 */
        }
        .legend-color {
            width: 20px; /* 颜色块的宽度 */
            height: 20px; /* 颜色块的高度 */
            margin-right: 5px; /* 颜色块和文字的间隔 */
        }
        .lower { background-color: rgba(89, 164, 222, 1); }
        .average { background-color: rgba(247, 214, 73, 1); }
        .high { background-color: rgba(220, 117, 58, 1); }
        body {
            font-family: Arial, sans-serif;
            display: flex; 
            flex-direction: row; 
            align-items: center; 
        }

        .courtDiv {
            width: 100%;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }
        .courtDiv canvas{
            width: 100%;
            margin-top: 10px;
            margin-bottom: 5px; 
        }
        /* body {
            background-color: white;
            font-family: 'Arial', sans-serif;
            background-image: url('../static/2index.jpg');
            background-size: cover;
            background-repeat: no-repeat;
            position: relative; 
            opacity: 0.9;
        }
        html::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7); 
            z-index: -10;
        } */
    </style>
    <script src="../static/script.js"></script>
    <script src="../static/court.js"></script>
</head>
<body>
    <div class="container">

        <div class="row profile-header">
            <nav class="navbar navbar-expand-lg bg-body-tertiary mb-2 navbar-light p-0 pt-2 pb-2" style="background-color: rgba(255,255,255,0.7);">
                <div class="container-fluid">
                  <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarTogglerDemo03" aria-controls="navbarTogglerDemo03" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon" ></span>
                  </button>
                  <a class="navbar-brand" href="#"><img src="static/5logo.png" alt="logo" class="navbar-toggler-icon me-2" >数据中心</a>
                  <div class="collapse navbar-collapse" id="navbarTogglerDemo03">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                      <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="/"><i class="bi bi-dribbble me-1"></i>训练中心</a>
                    </ul>
                  </div>
                </div>
              </nav>

            <div class="col-md-12">
                <img src="../static/avator0.png" alt="头像" class="rounded-circle" width="100" >
                <h1 style="color: white;">用户名</h1>
            </div>
        </div>
        <ul class="nav nav-tabs">
            <li class="nav-item col-md-2">
              <a class="nav-link active" aria-current="page" href="#" data-x="weekly">周数据</a>
            </li>
            <li class="nav-item col-md-2">
              <a class="nav-link" href="#" data-x="monthly">月数据</a>
            </li>
            <li class="nav-item col-md-2">
              <a class="nav-link" href="#" data-x="all-time">年数据</a>
            </li class="col-md-6">
                <div class="col-md-6">
                    <div class="d-flex justify-content-center align-items-center my-3">
                        <button id="prev" class="btn btn-outline-secondary"> < </button>
                        <span id="date-display" class="mx-3 fs-4"></span>
                        <button id="next" class="btn btn-outline-secondary"> > </button>
                    </div>
                </div>
          </ul>
        <div class="row chart-container">
            <div class="col-md-6">
                <div class="chart" id="svgChart" >
                    <h2>折线图</h2>
                    <svg id="LineSvg" ></svg>
                    <!-- 在这里插入你的折线图代码 -->
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart">
                    <h2>命中分布图</h2>
                    <div class="courtDiv">
                        <!-- <h2>区域命中率图</h2> -->
                        <canvas id="myCanvas"></canvas>
                        <div id="legend">
                            <div class="legend-item">
                                <div class="legend-color high"></div>
                                <div>高于平均水平</div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color average"></div>
                                <div>处于平均水平</div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color lower"></div>
                                <div>低于平均水平</div>
                            </div>
                        </div>
                    </div>
                    <!-- 在这里插入你的分布图代码 -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>


    <script>

        //动态调整其svg大小
        function setSvgSize(data) {
            var containerWidth = document.getElementById('svgChart').clientWidth;
            var svgChart=document.getElementById('svgChart');

            d3.select('#LineSvg').selectAll('*').remove();
                    d3.select('#LineSvg')
                    .attr('width', containerWidth*0.95)
                    .attr('height', containerWidth * 0.95);  
                    drawLineGraph(data, svgId='LineSvg');          
        }

        function generateRandomTimestamps(start, end,count=10) {
            const startDate = start;// 2024年5月10日
            const endDate = end; // 2024年5月24日

            const randomTime = () => {
                const baseTime = Math.floor(Math.random() * (endDate - startDate)) + startDate.getTime();
                const startTime = baseTime;
                const endTime = startTime + Math.floor(Math.random() * 2 * 60 * 60 * 1000) + 1; // 随机增加1到2小时的时间戳
                return { trainStartTime: startTime, trainEndTime: endTime };
            };

            const randomShoot = () => {
                return {
                    nx: Math.random(),
                    ny: Math.random(),
                    score: Math.random() > 0.5
                };
            };

            const randomUserData = () => ({
                trainStartTime: randomTime().trainStartTime,
                trainEndTime: randomTime().trainEndTime,
                Shoots: Array.from({ length: Math.floor(Math.random() * 30) + 1 }, randomShoot)
            });

            return Array.from({ length: count }, randomUserData);
        }

        function filterData(startDate, endDate, userData) {
            // 将日期转换为时间戳
            startDate.setHours(0,0,0);
            endDate.setHours(23,59,59);
            // console.log("filter",startDate,endDate);
            const startTimeStamp = startDate.getTime();
            const endTimeStamp = endDate.getTime();

            // 使用filter方法筛选数据
            return userData.filter(user => {
                const trainStartTime = user.trainStartTime; // 获取trainStartTime时间戳
                return trainStartTime >= startTimeStamp && trainStartTime <= endTimeStamp;
            });
        }

        function DataFormat2Line(userData) {
            const summary = []; // 用于存储最终的统计结果
            const dayData = new Map(); // 使用Map来存储每天的统计数据

            // 遍历userData数组，统计每天的hits和misses
            userData.forEach(user => {
                // 将时间戳转换为Date对象
                const date = new Date(user.trainStartTime);
                // 获取日期的表示形式，例如 "2024-05-10"
                const dateString = date.toISOString().slice(0, 10);
                
                // 累加hits和misses
                user.Shoots.forEach(shoot => {
                    let dayEntry = dayData.get(dateString);
                    if (!dayEntry) {
                        dayEntry = { hits: 0, misses: 0 };
                        dayData.set(dateString, dayEntry);
                    }
                    if (shoot.score) {
                        dayEntry.hits++;
                    } else {
                        dayEntry.misses++;
                    }
                });
            });

            // 将Map转换为数组，并添加day索引
            dayData.forEach((value, key, map) => {
                const dayIndex = new Date(key).getDate(); // 获取日期中的天数部分
                summary.push({
                    day: dayIndex,
                    hits: value.hits,
                    misses: value.misses
                });
            });

            return summary;
        }

        function getDaysInMonth(date) {
            // 月份是从0开始的，所以需要+1
            const month = date.getMonth() + 1;
            const year = date.getFullYear();

            // 创建一个新的日期对象，设置为下一个月的第一天
            const nextMonth = new Date(year, month, 0).getDate();

            // 返回这个月的天数
            return nextMonth;
        }

        function summarizeByMonth(userData) {
            // 创建一个对象来存储每个月的统计数据
            const monthlySummary = {};

            // 遍历userData数组，统计每个月的hits和misses
            userData.forEach(user => {
                const month = new Date(user.trainStartTime).getMonth() + 1; // 获取月份，+1因为getMonth()返回的月份是从0开始的
                const year = new Date(user.trainStartTime).getFullYear(); // 获取年份

                // 如果这个月还没有在monthlySummary中，初始化它
                if (!monthlySummary[month]) {
                    monthlySummary[month] = { hits: 0, misses: 0 };
                }

                // 遍历Shoots数组，累加hits和misses
                user.Shoots.forEach(shoot => {
                    if (shoot.score) {
                        monthlySummary[month].hits += 1;
                    } else {
                        monthlySummary[month].misses += 1;
                    }
                });
            });
            
            // 获取所有月份的数组，从1月到12月
            const allMonths = Array.from({ length: 12 }, (v, i) => i + 1);

            // 确保每个月都有记录，补充缺失的月份
            allMonths.forEach(month => {
                if (!monthlySummary[month]) {
                    monthlySummary[month] = { hits: 0, misses: 0 };
                }
            });

            // 将对象转换为数组，并按月份排序
            const summaryArray = allMonths.map(month => {
                return {
                    day: month,
                    hits: monthlySummary[month].hits,
                    misses: monthlySummary[month].misses
                };
            });

            return summaryArray;
        }

        function extractShootsList(userData) {
            // 创建一个新的空数组用于存储所有Shoots
            let allShoots = [];

            // 遍历userData数组，将每个用户的Shoots添加到allShoots数组中
            userData.forEach(user => {
                allShoots = allShoots.concat(user.Shoots);
            });

            // 或者使用展开运算符
            // userData.forEach(user => {
            //   allShoots.push(...user.Shoots);
            // });

            return allShoots;
        }

        function extractData(startDate, endDate, userData,mode=0){
            let data1=filterData(startDate, endDate, userData);
            let data2=DataFormat2Line(data1);
            if(mode==0){
                //week
                let thisWeek=[]
                for(let i=0;i<7;i++){
                    let newDate = new Date(startDate);
                    newDate.setDate(startDate.getDate() + i);
                    let temp={
                        day:newDate.getDate(),
                        hits:0,
                        misses:0,
                    }
                    for(let obj of data2){
                        if(obj.day==temp.day){
                            temp=obj;
                            break;
                        }
                    }
                    thisWeek.push(temp);
                }
                for(let i=0;i<7;i++){
                    thisWeek[i].day=i+1;
                }
                console.log(thisWeek);
                return thisWeek;
            }
            if(mode==1){
                //month
                let thisMonth=[];
                for(let i=0;i<getDaysInMonth(startDate);i++){
                    let temp={
                        day:i+1,
                        hits:0,
                        misses:0,
                    }
                    thisMonth.push(temp);
                }
                for(let i=0;i<data2.length;i++){
                    //有bug 不知道为什么，在二月会出现31的数据，为了暂时解决这个bug 添加if:
                    //有出现新的bug 二月最后一天都是0 但week时 又有数据
                    //周数据与月数据对不上
                    //每周最后一天都是错的
                    //每月最后一天是错的
                    //bug解决，将line 240 241   0h0m0s开始 23h59m59s结束
                    //还剩一个小问题 偶尔 周数据中会有一个数据不对
                    if(data2[i].day-1<thisMonth.length){
                        thisMonth[data2[i].day-1]=data2[i];
                        // console.log(data2[i].day-1,thisMonth[data2[i].day-1].day,"-->",data2[i].day,data2[i]);
                    }
                    // else{
                    //     console.log("大于当前日期-->",data2[i].day,data2[i]);
                    // }
                }
                console.log(thisMonth);
                return thisMonth;
            }
            if(mode==2){
                //year
                let thisYear=summarizeByMonth(data1);
                console.log(thisYear);
                return thisYear;
            }
            if(mode==3){
                //右侧分布图
                return extractShootsList(data1);
            }
        }

        function updateTwoGraph(Date1,Date2,userData,mode=0){
            let result_data=extractData(Date1,Date2,userData,mode)
            let shootingInfo=extractData(Date1,Date2,userData,3);

            var canvas = document.getElementById('myCanvas');
            var ctx = canvas.getContext('2d');
            let canvasSize=400;
            drawCourt(canvas,ctx,shootingInfo,canvasSize,Math.max(1,canvasSize*(1/50)),'white',
                            null_color='rgba(180, 180, 180, 1)',
                            lower_color='rgba(89, 164, 222, 1)',
                            average_color='rgba(247, 214, 73,1)',
                            high_color='rgba(220, 117, 58, 1)',
                            lower_percent=0.3,
                            high_percent=0.5);

            setSvgSize(result_data);

            window.addEventListener('resize', function() {
                setSvgSize(result_data);
            });
        }

        const queryParams = new URLSearchParams(window.location.search);
        const userID = queryParams.get('userID');
        var userData=[]

        fetch("/getAllShootingInfo", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ 
                    userID:'123',
                    start : "2023-05-10",
                    end : "2024-05-25",
                    count:3500
                }),
                })
                .then((response) => response.json())
                .then((shooting_data) => {
                    userData=shooting_data;
                    updateWeekDisplay();
                })

    </script>
    <script>
        const dateDisplay = document.getElementById('date-display');
        const prevButton = document.getElementById('prev');
        const nextButton = document.getElementById('next');

        const prevYearButton = document.getElementById('prev-year');
        const nextYearButton = document.getElementById('next-year');
    
        let currentDate = new Date();  // 设置初始日期为2024年4月

        function updateWeekDisplay() {
            let startOfWeek = new Date(currentDate);
            startOfWeek.setDate(currentDate.getDate() - currentDate.getDay() + 1);  // 设置为本周一
            let endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);  // 设置为本周日
    
            const dateFormatter = new Intl.DateTimeFormat('en-US', { month: 'short', day: 'numeric' });
            dateDisplay.textContent = `${dateFormatter.format(startOfWeek)} - ${dateFormatter.format(endOfWeek)}`;
            updateTwoGraph(startOfWeek,endOfWeek,userData,0);

        }

        function updateDateDisplay() {
            const monthNames = ["一月", "二月", "三月", "四月", "五月", "六月",
                "七月", "八月", "九月", "十月", "十一月", "十二月"];

            dateDisplay.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

            function getFirstAndLastDayOfMonth(date) {
                // 获取这个月的第一天
                let firstDayOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
                // 获取下个月的第一天（这将自动回卷到这个月的最后一天）
                let lastDayOfMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0);
                // console.log(firstDayOfMonth,lastDayOfMonth)
                return { firstDayOfMonth, lastDayOfMonth }               
            }

            let {firstDayOfMonth,lastDayOfMonth}=getFirstAndLastDayOfMonth(currentDate);
            updateTwoGraph(firstDayOfMonth,lastDayOfMonth,userData,1);

        }

        function updateDateDisplayYear() {
            dateDisplay.textContent = `${currentDate.getFullYear()}`;
            function getFirstAndLastDayOfYear(date) {
                // 获取这一年的第一天
                let firstDayOfYear = new Date(date.getFullYear(), 0, 1);

                // 获取下一年的第一天（这将自动回卷到这一年的最后一天）
                let lastDayOfYear = new Date(date.getFullYear(), 12, 0);

                return { firstDayOfYear, lastDayOfYear };
            }
            const { firstDayOfYear, lastDayOfYear } = getFirstAndLastDayOfYear(currentDate);
            updateTwoGraph(firstDayOfYear,lastDayOfYear,userData,2);
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            prevButton.addEventListener('click', () => {
                if(dataX=='weekly'){
                    currentDate.setDate(currentDate.getDate() - 7);  
                    updateWeekDisplay();
                }
                else if (dataX=='monthly'){
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    updateDateDisplay();
                }
                else if(dataX=='all-time'){
                    currentDate.setFullYear(currentDate.getFullYear() - 1);
                    updateDateDisplayYear();
                }

            });
        
            nextButton.addEventListener('click', () => {
                if(dataX=='weekly'){
                    currentDate.setDate(currentDate.getDate() + 7);
                    updateWeekDisplay();
                }
                else if (dataX=='monthly'){
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    updateDateDisplay();
                }
                else if(dataX=='all-time'){
                    currentDate.setFullYear(currentDate.getFullYear() + 1);
                    updateDateDisplayYear();
                }
            });
            if(dataX=='weekly'){
                updateWeekDisplay();
            }
            else if (dataX=='monthly'){
                updateDateDisplay();
            }
            else if(dataX=='all-time'){
                updateDateDisplayYear();
            }
        });
    </script>
        
    <script>
        var dataX='weekly';
        document.addEventListener("DOMContentLoaded", function() {
            var navLinks = document.querySelectorAll(".nav-item a");
            // 为每个链接添加点击事件监听器
            navLinks.forEach(function(link) {
                link.addEventListener("click", function(event) {
                    // event.preventDefault();  // 阻止链接默认跳转行为

                    // 移除所有链接的active类
                    navLinks.forEach(function(link) {
                        link.classList.remove("active");
                    });
                    // 给被点击的链接添加active类
                    this.classList.add("active");
                    dataX = this.dataset.x;
                    if(dataX=='weekly'){
                        updateWeekDisplay();
                    }
                    else if(dataX=='monthly'){
                        updateDateDisplay();
                    }
                    else if(dataX=='all-time'){
                        updateDateDisplayYear();
                    }
                    // setSvgSize();

                });
            });
        });
    </script>
</body>
</html>
